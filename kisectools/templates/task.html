{% extends 'base.html' %}

{% block title %}任务管理{% endblock %}

{% block header %}任务管理{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-3">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTaskModal">新增</button>
    </div>
    <!-- 添加任务模态框 -->
    <div class="modal fade" id="addTaskModal" tabindex="-1" aria-labelledby="addTaskModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addTaskModalLabel">创建新任务</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addTaskForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="mb-3">
                            <label for="taskName" class="form-label">任务名称</label>
                            <input class="form-control" type="text" id="taskName" name="task_name" placeholder="输入任务名称" required>
                        </div>
                        <div class="mb-3">
                            <label for="deviceSelect" class="form-label">选择设备</label>
                            <select class="form-select" id="deviceSelect" name="device_id" required>
                                <option value="" disabled selected>选择设备</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="ipStr" class="form-label">IP 范围</label>
                            <input class="form-control" type="text" id="ipStr" name="ip_str" placeholder="例如: 192.168.1.1-192.168.1.255" required>
                        </div>
                        <div class="mb-3">
                            <label for="portStr" class="form-label">端口范围</label>
                            <input class="form-control" type="text" id="portStr" name="port_str" placeholder="例如: 80,443,8000-9000" required>
                        </div>
                        <button type="submit" class="btn btn-primary">创建任务</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- 模态框结束 -->
    <table class="table table-striped">
        <thead>
            <tr>
                <th>ID</th>
                <th>任务名称</th>
                <th>任务状态</th>
                <th>任务创建时间</th>
                <th>用户</th>
                <th>设备</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for task in tasks.data %}
            <tr>
                <td>{{ task.id }}</td>
                <td>{{ task.task_name }}</td>
                <td>{{ task.task_status }}</td>
                <td>{{ task.create_time}}</td>
                <td>{{ task.user }}</td>
                <td>{{ task.device }}</td>
                <td>
                    <button id="monitor_{{ task.id }}" class="btn btn-sm btn-warning">监控</button>
                    <button id="detail_{{ task.id }}" class="btn btn-sm btn-info">结果</button>
                    <button id="delete_{{ task.id }}" class="btn btn-sm btn-danger">删除</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <nav class="d-flex justify-content-between align-items-center">
        <ul class="pagination mb-0">
            {% set total_pages = (tasks.total // tasks.per_page) + (1 if tasks.total % tasks.per_page > 0 else 0) %}
            <li class="page-item {% if tasks.page <= 1 %}disabled{% endif %}">
                <a class="page-link" href="?page={{ tasks.page - 1 if tasks.page > 1 else 1 }}&per_page={{ tasks.per_page }}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
            {% for page_num in range(1, total_pages + 1) %}
            <li class="page-item {% if page_num == tasks.page %}active{% endif %}">
                <a class="page-link" href="?page={{ page_num }}&per_page={{ tasks.per_page }}">{{ page_num }}</a>
            </li>
            {% endfor %}
            <li class="page-item {% if tasks.page >= total_pages %}disabled{% endif %}">
                <a class="page-link" href="?page={{ tasks.page + 1 if tasks.page < total_pages else total_pages }}&per_page={{ tasks.per_page }}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
        </ul>
        <form method="get" class="d-inline-block ms-3">
            <label for="per_page" class="me-2">每页显示数量:</label>
            <select id="per_page" name="per_page" class="form-select d-inline-block w-auto" onchange="this.form.submit()">
                <option value="5" {% if tasks.per_page == 5 %}selected{% endif %}>5</option>
                <option value="10" {% if tasks.per_page == 10 %}selected{% endif %}>10</option>
                <option value="20" {% if tasks.per_page == 20 %}selected{% endif %}>20</option>
            </select>
        </form>
    </nav>
    <p class="text-center mt-3">
        当前第 {{ tasks.page }} 页，每页 {{ tasks.per_page }} 条，共 {{ tasks.total }} 条数据。
    </p>

    <div id="taskDetailModal" class="modal fade" tabindex="-1" aria-labelledby="taskDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="taskDetailModalLabel">任务详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <style>
                        #taskDetailModal .modal-dialog {
                            max-width: 70%; /* 设置模态框宽度为90% */
                        }
                    </style>
                    <p><strong>统计：</strong>IP存活: <span id="detailUniqueIPs"></span>个，端口存活数: <span id="detailTotalPorts"></span>个</p>

                    <p><strong>任务结果:</strong></p>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>主机</th>
                                <th>端口</th>
                                <th>状态</th>
                                <th>服务</th>
                                <th>创建时间</th>
                            </tr>
                        </thead>
                        <tbody id="detailTaskResultTable">
                            <!-- 动态填充任务结果 -->
                        </tbody>
                    </table>
                    <nav>
                        <ul class="pagination" id="pagination">
                            <!-- 动态生成分页按钮 -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

<script>
    document.addEventListener("DOMContentLoaded", async function () {
        // 加载设备列表
        const deviceSelect = document.getElementById("deviceSelect");
        try {
            const response = await axios.get('/device/query_all_device', {
                headers: {
                    'Content-Type': 'application/json',
                },
                withCredentials: true
            });
            if (response.status === 200 && response.data.devices) {
                response.data.devices.forEach(device => {
                    const option = document.createElement("option");
                    option.value = device.id;
                    option.textContent = device.name;
                    deviceSelect.appendChild(option);
                });
            }
        } catch (error) {
            console.error('加载设备失败:', error.response?.data?.error || error.message);
        }

        // 新增任务表单提交逻辑
        const addTaskForm = document.getElementById("addTaskForm");
        const addTaskModal = new bootstrap.Modal(document.getElementById("addTaskModal"));
        
        addTaskForm.addEventListener("submit", async function (event) {
            event.preventDefault();

            const formData = new FormData(this);
            const data = {
                task_name: formData.get('task_name'),
                device_id: formData.get('device_id'),
                ip_str: formData.get('ip_str'),
                port_str: formData.get('port_str')
            };

            try {
                const response = await axios.post('/task/add', data, {
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    withCredentials: true
                });

                if (response.status === 200) {
                    alert('任务创建成功！');
                    addTaskModal.hide();
                    location.reload(); // 刷新页面
                }
            } catch (error) {
                alert(error.response?.data?.error || '创建任务失败，请稍后重试。');
            }
        });

        // 删除任务逻辑
        document.querySelectorAll("button[id^='delete_']").forEach(button => {
            button.addEventListener("click", async function () {
                const taskId = this.id.split('_')[1];
                if (confirm("确定要删除此任务吗？")) {
                    try {
                        const response = await axios.post('/task/delete', { task_id: taskId }, {
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            withCredentials: true
                        });
                        if (response.status === 200) {
                            alert('任务已删除！');
                            location.reload();
                        }
                    } catch (error) {
                        alert(error.response?.data?.error || '删除任务失败，请稍后重试。');
                    }
                }
            });
        });

        // 查看任务详情逻辑
        document.querySelectorAll("button[id^='detail_']").forEach(button => {
            button.addEventListener("click", async function () {
                const taskId = this.id.split('_')[1];
                const page = 1; // 默认第一页
                const perPage = 10; // 每页显示10条

                async function fetchTaskDetails(page) {
                    try {
                        const response = await axios.post('/task/detail', { task_id: taskId, page, per_page: perPage }, {
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            withCredentials: true
                        });

                        if (response.status === 200) {
                            const data = response.data;
                            document.getElementById("detailUniqueIPs").textContent = data.unique_ips;
                            document.getElementById("detailTotalPorts").textContent = data.total_ports;

                            const resultTable = document.getElementById("detailTaskResultTable");
                            resultTable.innerHTML = "";
                            data.task_result.forEach(result => {
                                const row = document.createElement("tr");
                                row.innerHTML = `
                                    <td>${result.host}</td>
                                    <td>${result.port}</td>
                                    <td>${result.status}</td>
                                    <td>${result.service}</td>
                                    <td>${new Date(result.create_time).toLocaleString()}</td>
                                `;
                                resultTable.appendChild(row);
                            });

                            const pagination = document.getElementById("pagination");
                            pagination.innerHTML = "";
                            for (let i = 1; i <= Math.ceil(data.total / data.per_page); i++) {
                                const li = document.createElement("li");
                                li.className = `page-item ${i === data.page ? 'active' : ''}`;
                                li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                                li.addEventListener("click", (e) => {
                                    e.preventDefault();
                                    fetchTaskDetails(i);
                                });
                                pagination.appendChild(li);
                            }
                        }
                    } catch (error) {
                        alert(error.response?.data?.error || '获取任务详情失败，请稍后重试。');
                    }
                }

                // 首次点击详情时显示模态框
                const taskDetailModal = new bootstrap.Modal(document.getElementById("taskDetailModal"));
                taskDetailModal.show();

                // 加载第一页数据
                fetchTaskDetails(page);
            });
        });
    });
</script>
{% endblock %}
